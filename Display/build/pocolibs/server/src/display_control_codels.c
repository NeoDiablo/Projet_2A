/* --- Generated by genom 2.99.29. Do not edit -------------------------- */

#include "autoconf/acheader.h"

#include <signal.h>
#include <unistd.h>

#include "display_c_types.h"
#include "typecopy.h"
#include "display_parameters.h"
#include "display_control_task.h"


/* --- genom_abort_activity_codel ------------------------------------------ */

genom_event
genom_abort_activity_codel(uint32_t activity, genom_context ctx)
{
  if (activity & 0x80000000UL)
    return genom_no_such_activity(ctx);

  /* task orders */
  {
    struct genom_component_data *self = ctx->data->self;
    struct genom_activity *a;
    size_t id;

    pthread_mutex_lock(&self->tasks.orders.lock);
    for(id = 0; id < genom_max_activities(); id++) {
      a = &self->tasks.orders.activities.a[id].any;
      switch(a->status) {
        case ACT_VOID: continue;

        case ACT_INIT: case ACT_RUN:
          if (a->aid != (int32_t)activity) continue;
          a->stop = 1;
          a->interruptedby = "abort_activity";
          pthread_mutex_unlock(&self->tasks.orders.lock);
          return genom_ok;

        case ACT_STOP: case ACT_ETHER:
          if (a->aid != (int32_t)activity) continue;
          pthread_mutex_unlock(&self->tasks.orders.lock);
          return genom_ok;
      }
    }
    pthread_mutex_unlock(&self->tasks.orders.lock);
  }

  /* task monitor */
  {
    struct genom_component_data *self = ctx->data->self;
    struct genom_activity *a;
    size_t id;

    pthread_mutex_lock(&self->tasks.monitor.lock);
    for(id = 0; id < genom_max_activities(); id++) {
      a = &self->tasks.monitor.activities.a[id].any;
      switch(a->status) {
        case ACT_VOID: continue;

        case ACT_INIT: case ACT_RUN:
          if (a->aid != (int32_t)activity) continue;
          a->stop = 1;
          a->interruptedby = "abort_activity";
          pthread_mutex_unlock(&self->tasks.monitor.lock);
          return genom_ok;

        case ACT_STOP: case ACT_ETHER:
          if (a->aid != (int32_t)activity) continue;
          pthread_mutex_unlock(&self->tasks.monitor.lock);
          return genom_ok;
      }
    }
    pthread_mutex_unlock(&self->tasks.monitor.lock);
  }

  return genom_no_such_activity(ctx);
}


/* --- genom_connect_port_codel -------------------------------------------- */

genom_event
genom_connect_port_codel(const char local[128], const char remote[128],
                         genom_context ctx)
{
  struct genom_component_data *self = ctx->data->self;
  genom_event s;
  (void)local; (void)remote; /* fix -Wunused-parameter */

  genom_take_resource(
    self,
    self->resources.task_orders ||
    self->resources.task_monitor ||
    self->resources.all,

    self->resources.all = 1);

  /* find the inport */
  if (!strcmp(local, "IM")) {
    s = genom_display_IM_connect(remote, ctx);
    goto done;
  }
  if (!strcmp(local, "AR")) {
    s = genom_display_AR_connect(remote, ctx);
    goto done;
  }
  if (!strcmp(local, "POS")) {
    s = genom_display_POS_connect(remote, ctx);
    goto done;
  }
  if (!strcmp(local, "BAT")) {
    s = genom_display_BAT_connect(remote, ctx);
    goto done;
  }

  s = genom_no_such_inport(ctx);
  goto done;

done:
  genom_give_resource(self, self->resources.all = 0);
  return s;
}


/* --- genom_connect_remote_codel ------------------------------------------ */

genom_event
genom_connect_remote_codel(const char local[128], const char remote[128],
                           genom_context ctx)
{
  struct genom_component_data *self = ctx->data->self;
  genom_event s;
  (void)local; (void)remote; /* fix -Wunused-parameter */

  genom_take_resource(
    self,
    self->resources.task_orders ||
    self->resources.task_monitor ||
    self->resources.all,

    self->resources.all = 1);

  /* find the remote */

  s = genom_no_such_remote(ctx);
  goto done;

done:
  genom_give_resource(self, self->resources.all = 0);
  return s;
}


/* --- genom_kill_codel ---------------------------------------------------- */

genom_event
genom_kill_codel(genom_context self)
{
  (void)self; /* fix -Wunused-parameter */
  kill(getpid(), SIGTERM);
  return genom_ok;
}


/* --- Service abort_activity control codels ---------------------------- */

genom_event
genom_display_abort_activity_controlcb(
  struct genom_component_data *self,
  struct genom_display_abort_activity_activity *a)
{
  genom_event s = genom_ok;
  (void)self; (void)a; /* fix -Wunused-parameter */

  /* check allowance (before/after statements) */

  /* copy inout parameters to output */

  /* call validate codel */

  /* copy ids parameters to ids (attributes) */

  /* call simple codels */
  genom_take_resource(
    self,
    self->resources.all,

    self->resources.control = genom_abort_activity_codel);
  s = genom_abort_activity_codel(a->in.activity, &self->control.context);
  genom_give_resource(self, self->resources.control = NULL);

  genom_log_debug("service %s codel %s returned %s",
                  "abort_activity", "genom_abort_activity_codel", s?s:"ok");
  if (s
      && s != genom_incompatible_digest_id
      && s != genom_bad_transition_id
      && s != genom_interrupted_id
      && s != genom_serialization_id
      && s != genom_too_many_activities_id
      && s != genom_disallowed_id
      && s != genom_mwerr_id
      && s != genom_no_such_activity_id
      ) {
    genom_unkex_detail d;
    strncpy(d.what, s, sizeof(d.what)); d.what[sizeof(d.what)-1] = *"";
    genom_log_warn(
      0, "unknown exception %s for codel %s in service %s",
      s, "genom_abort_activity_codel", "abort_activity");
    s = genom_unkex(&d, &self->control.context);
  }
  if (s) return s;

  return s;
}


/* --- Service connect_port control codels ------------------------------ */

genom_event
genom_display_connect_port_controlcb(
  struct genom_component_data *self,
  struct genom_display_connect_port_activity *a)
{
  genom_event s = genom_ok;
  (void)self; (void)a; /* fix -Wunused-parameter */

  /* check allowance (before/after statements) */

  /* copy inout parameters to output */

  /* call validate codel */

  /* copy ids parameters to ids (attributes) */

  /* call simple codels */
  genom_take_resource(
    self,
    self->resources.all,

    self->resources.control = genom_connect_port_codel);
  s = genom_connect_port_codel(a->in.local, a->in.remote, &self->control.context);
  genom_give_resource(self, self->resources.control = NULL);

  genom_log_debug("service %s codel %s returned %s",
                  "connect_port", "genom_connect_port_codel", s?s:"ok");
  if (s
      && s != genom_incompatible_digest_id
      && s != genom_bad_transition_id
      && s != genom_interrupted_id
      && s != genom_serialization_id
      && s != genom_too_many_activities_id
      && s != genom_disallowed_id
      && s != genom_mwerr_id
      && s != genom_no_such_inport_id
      && s != genom_no_such_outport_id
      && s != genom_port_io_id
      ) {
    genom_unkex_detail d;
    strncpy(d.what, s, sizeof(d.what)); d.what[sizeof(d.what)-1] = *"";
    genom_log_warn(
      0, "unknown exception %s for codel %s in service %s",
      s, "genom_connect_port_codel", "connect_port");
    s = genom_unkex(&d, &self->control.context);
  }
  if (s) return s;

  return s;
}


/* --- Service connect_service control codels --------------------------- */

genom_event
genom_display_connect_service_controlcb(
  struct genom_component_data *self,
  struct genom_display_connect_service_activity *a)
{
  genom_event s = genom_ok;
  (void)self; (void)a; /* fix -Wunused-parameter */

  /* check allowance (before/after statements) */

  /* copy inout parameters to output */

  /* call validate codel */

  /* copy ids parameters to ids (attributes) */

  /* call simple codels */
  genom_take_resource(
    self,
    self->resources.all,

    self->resources.control = genom_connect_remote_codel);
  s = genom_connect_remote_codel(a->in.local, a->in.remote, &self->control.context);
  genom_give_resource(self, self->resources.control = NULL);

  genom_log_debug("service %s codel %s returned %s",
                  "connect_service", "genom_connect_remote_codel", s?s:"ok");
  if (s
      && s != genom_incompatible_digest_id
      && s != genom_bad_transition_id
      && s != genom_interrupted_id
      && s != genom_serialization_id
      && s != genom_too_many_activities_id
      && s != genom_disallowed_id
      && s != genom_mwerr_id
      && s != genom_no_such_remote_id
      && s != genom_no_such_service_id
      && s != genom_remote_io_id
      ) {
    genom_unkex_detail d;
    strncpy(d.what, s, sizeof(d.what)); d.what[sizeof(d.what)-1] = *"";
    genom_log_warn(
      0, "unknown exception %s for codel %s in service %s",
      s, "genom_connect_remote_codel", "connect_service");
    s = genom_unkex(&d, &self->control.context);
  }
  if (s) return s;

  return s;
}


/* --- Service kill control codels -------------------------------------- */

genom_event
genom_display_kill_controlcb(
  struct genom_component_data *self,
  struct genom_display_kill_activity *a)
{
  genom_event s = genom_ok;
  (void)self; (void)a; /* fix -Wunused-parameter */

  /* check allowance (before/after statements) */

  /* copy inout parameters to output */

  /* call validate codel */

  /* copy ids parameters to ids (attributes) */

  /* call simple codels */
  genom_take_resource(
    self,
    self->resources.all,

    self->resources.control = genom_kill_codel);
  s = genom_kill_codel(&self->control.context);
  genom_give_resource(self, self->resources.control = NULL);

  genom_log_debug("service %s codel %s returned %s",
                  "kill", "genom_kill_codel", s?s:"ok");
  if (s
      && s != genom_incompatible_digest_id
      && s != genom_bad_transition_id
      && s != genom_interrupted_id
      && s != genom_serialization_id
      && s != genom_too_many_activities_id
      && s != genom_disallowed_id
      && s != genom_mwerr_id
      ) {
    genom_unkex_detail d;
    strncpy(d.what, s, sizeof(d.what)); d.what[sizeof(d.what)-1] = *"";
    genom_log_warn(
      0, "unknown exception %s for codel %s in service %s",
      s, "genom_kill_codel", "kill");
    s = genom_unkex(&d, &self->control.context);
  }
  if (s) return s;

  return s;
}


/* --- Service GetCurrentPosition control codels ------------------------ */

genom_event
genom_display_GetCurrentPosition_controlcb(
  struct genom_component_data *self,
  struct genom_display_GetCurrentPosition_activity *a)
{
  genom_event s = genom_ok;
  (void)self; (void)a; /* fix -Wunused-parameter */

  /* check allowance (before/after statements) */

  /* copy inout parameters to output */

  /* call validate codel */

  /* copy ids parameters to ids (attributes) */
  genom_take_resource(
    self,
    self->resources.task_monitor == InitMonitorParameters ||
    self->resources.task_monitor == StartMonitoring ||
    self->resources.all,

    self->resources.control = genom_display_GetCurrentPosition_controlcb);
  genom_tcopy_t_camera_robot(
    &(a->out.position),
    &(self->ids.position));
  genom_give_resource(self, self->resources.control = NULL);

  /* call simple codels */

  return s;
}


/* --- Service GetCurrentBattery control codels ------------------------- */

genom_event
genom_display_GetCurrentBattery_controlcb(
  struct genom_component_data *self,
  struct genom_display_GetCurrentBattery_activity *a)
{
  genom_event s = genom_ok;
  (void)self; (void)a; /* fix -Wunused-parameter */

  /* check allowance (before/after statements) */

  /* copy inout parameters to output */

  /* call validate codel */

  /* copy ids parameters to ids (attributes) */
  genom_take_resource(
    self,
    self->resources.task_monitor == InitMonitorParameters ||
    self->resources.task_monitor == StartMonitoring ||
    self->resources.all,

    self->resources.control = genom_display_GetCurrentBattery_controlcb);
  genom_tcopy_t_loco_data(
    &(a->out.batterie),
    &(self->ids.batterie));
  genom_give_resource(self, self->resources.control = NULL);

  /* call simple codels */

  return s;
}


/* --- Service GetCurrentMap control codels ----------------------------- */

genom_event
genom_display_GetCurrentMap_controlcb(
  struct genom_component_data *self,
  struct genom_display_GetCurrentMap_activity *a)
{
  genom_event s = genom_ok;
  (void)self; (void)a; /* fix -Wunused-parameter */

  /* check allowance (before/after statements) */

  /* copy inout parameters to output */

  /* call validate codel */

  /* copy ids parameters to ids (attributes) */
  genom_take_resource(
    self,
    self->resources.task_monitor == InitMonitorParameters ||
    self->resources.task_monitor == StartMonitoring ||
    self->resources.all,

    self->resources.control = genom_display_GetCurrentMap_controlcb);
  genom_tcopy_t_camera_map(
    &(a->out.image),
    &(self->ids.image));
  genom_give_resource(self, self->resources.control = NULL);

  /* call simple codels */

  return s;
}


/* --- Service GetCurrentArena control codels --------------------------- */

genom_event
genom_display_GetCurrentArena_controlcb(
  struct genom_component_data *self,
  struct genom_display_GetCurrentArena_activity *a)
{
  genom_event s = genom_ok;
  (void)self; (void)a; /* fix -Wunused-parameter */

  /* check allowance (before/after statements) */

  /* copy inout parameters to output */

  /* call validate codel */

  /* copy ids parameters to ids (attributes) */
  genom_take_resource(
    self,
    self->resources.task_monitor == InitMonitorParameters ||
    self->resources.task_monitor == StartMonitoring ||
    self->resources.all,

    self->resources.control = genom_display_GetCurrentArena_controlcb);
  genom_tcopy_t_camera_arena(
    &(a->out.arene),
    &(self->ids.arene));
  genom_give_resource(self, self->resources.control = NULL);

  /* call simple codels */

  return s;
}


/* --- Service SendOrdersStop control codels ---------------------------- */

genom_event
genom_display_SendOrdersStop_controlcb(
  struct genom_component_data *self,
  struct genom_display_SendOrdersStop_activity *a)
{
  genom_event s = genom_ok;
  (void)self; (void)a; /* fix -Wunused-parameter */

  /* check allowance (before/after statements) */

  /* copy inout parameters to output */

  /* call validate codel */

  /* copy ids parameters to ids (attributes) */

  /* call simple codels */

  return s;
}


/* --- Service MonitoringStop control codels ---------------------------- */

genom_event
genom_display_MonitoringStop_controlcb(
  struct genom_component_data *self,
  struct genom_display_MonitoringStop_activity *a)
{
  genom_event s = genom_ok;
  (void)self; (void)a; /* fix -Wunused-parameter */

  /* check allowance (before/after statements) */

  /* copy inout parameters to output */

  /* call validate codel */

  /* copy ids parameters to ids (attributes) */

  /* call simple codels */

  return s;
}


/* --- Service SendOrders control codels -------------------------------- */

genom_event
genom_display_SendOrders_controlcb(
  struct genom_component_data *self,
  struct genom_display_SendOrders_activity *a)
{
  genom_event s = genom_ok;
  (void)self; (void)a; /* fix -Wunused-parameter */

  /* check allowance (before/after statements) */

  /* copy inout parameters to output */

  /* call validate codel */

  /* copy ids parameters to ids (attributes) */

  /* call simple codels */

  return s;
}


/* --- Service Monitoring control codels -------------------------------- */

genom_event
genom_display_Monitoring_controlcb(
  struct genom_component_data *self,
  struct genom_display_Monitoring_activity *a)
{
  genom_event s = genom_ok;
  (void)self; (void)a; /* fix -Wunused-parameter */

  /* check allowance (before/after statements) */

  /* copy inout parameters to output */

  /* call validate codel */

  /* copy ids parameters to ids (attributes) */

  /* call simple codels */

  return s;
}

/* eof */
