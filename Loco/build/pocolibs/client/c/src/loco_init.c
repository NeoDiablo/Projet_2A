/* --- Generated by genom 2.99.29. Do not edit -------------------------- */

#include "autoconf/acheader.h"

#include <errno.h>
#include <stdlib.h>
#include <stdio.h>
#include <string.h>

#include "genom3/c/client.h"
#include "private.h"
#include "loco/c/client.h"
#include "loco_msglib.h"


/* --- local data ---------------------------------------------------------- */

size_t loco_varmsg_maxsize = 32768;


/* --- loco_init -------------------------------------------------------- */

genom_client
genom_loco_client_init(int argc, char *argv[],
                            genom_event *ex, const void **exdetail)
{
  struct pocolibs_options opts;
  char *largv[argc+1];
  genom_state_component state;
  genom_client h;
  int i, e;

  h = malloc(sizeof(*h));
  if (!h) {
    if (ex) *ex = genom_fatal;
    if (exdetail) *exdetail = NULL;
    return NULL;
  }
  h->context.raise = genom_pocolibs_client_raise;
  h->context.raised = genom_pocolibs_client_raised;
  h->context.data = &h->context_data;

  h->context_data.h = h;
  h->context_data.ex = genom_ok;
  h->context_data.exdetail = NULL;
  h->context_data.exsize = 0;

  h->instance = NULL;
  h->csid = NULL;
  h->active_rqst = NULL;
  h->nactive = h->next = 0;

  /* must shift args so that getopt() works (argv[0] must be progname) */
  largv[0] = "loco";
  for(i=0; i<argc; i++) {
    largv[i+1] = argv[i];
  }

  if (pocolibs_getopt(h, argc+1, largv, &opts)) {
    if (ex) *ex = h->context_data.ex;
    if (exdetail) *exdetail = h->context_data.exdetail;
    free(h);
    return NULL;
  }
  loco_varmsg_maxsize = opts.varmsg_maxsize;

  if (pocolibs_init(h, LOCO_CLIENT_MBOX_REPLY_SIZE)) goto error;

  /* connect to server mbox */
  h->instance = strdup(opts.instance?opts.instance:"loco");
  e = csClientInit(h->instance,
                   LOCO_MAX_RQST_SIZE,
                   LOCO_MAX_INTERMED_REPLY_SIZE,
                   LOCO_MAX_REPLY_SIZE,
                   &h->csid);
  if (e != OK) {
    e = errnoGet();
    if (H2_SYS_ERR_FLAG(e))
      genom_syserr(&(genom_syserr_detail){ .code = e }, &h->context);
    else {
      genom_mwerr_detail d;
      h2getErrMsg(e, d.what, sizeof(d.what));
      genom_mwerr(&d, &h->context);
    }
    goto error;
  }

  /* check digest */
  genom_loco_client_genom_state_init_data(&state);
  if (genom_loco_client_genom_state_port(h, &state)) goto error;

  if (strcmp(state.digest, "51e2b712528b516da6f0cfe98dc4e8")) {
    genom_incompatible_digest_detail d;
    strcpy(d.server.version, state.version);
    strcpy(d.server.date, state.date);
    strcpy(d.client.version, "1.0");
    strcpy(d.client.date, "Wed Jul 19 15:18:05 CEST 2017");
    genom_incompatible_digest(&d, &h->context);
    genom_loco_client_genom_state_fini_data(&state);
    goto error;
  }
  genom_loco_client_genom_state_fini_data(&state);

  return h;

error:
  if (ex) *ex = h->context_data.ex;
  if (exdetail) *exdetail = h->context_data.exdetail;
  pocolibs_fini();
  if (h->instance) free(h->instance);
  free(h);
  return NULL;
}


/* --- loco_fini -------------------------------------------------------- */

void
genom_loco_client_fini(genom_client h)
{
  if (h) {
    if (h->csid) csClientEnd(h->csid);
    pocolibs_fini();
    if (h->instance) free(h->instance);
    if (h->active_rqst) free(h->active_rqst);
    free(h);
  }
}


/* --- loco_context ----------------------------------------------------- */

genom_context
genom_loco_client_context(genom_client h)
{
  return &h->context;
}


/* --- loco_name -------------------------------------------------------- */

const char *
genom_loco_client_instance(genom_client h)
{
  return h->instance;
}


/* --- loco_eventfd ----------------------------------------------------- */

int
genom_loco_client_eventfd(genom_client h)
{
  (void)h; /* fix -Wunused-parameter */
  return pocolibs_eventfd();
}


/* --- loco_service_info ------------------------------------------------ */

const struct genom_service_info *
genom_loco_client_service_info(genom_client h, int rqstid)
{
  return pocolibs_service_info(h, rqstid);
}


/* --- loco_done -------------------------------------------------------- */

int
genom_loco_client_done(genom_client h, int rqstid)
{
  return pocolibs_done(h, rqstid);
}


/* --- loco_wait -------------------------------------------------------- */

genom_event
genom_loco_client_wait(genom_client h, int rqstid)
{
  return pocolibs_waitterm(h, rqstid);
}


/* --- loco_clean ------------------------------------------------------- */

genom_event
genom_loco_client_clean(genom_client h, int rqstid)
{
  return pocolibs_clean(h, rqstid);
}


/* --- loco_doevents ---------------------------------------------------- */

genom_event
genom_loco_client_doevents(genom_client h)
{
  return pocolibs_doevents(h);
}


/* --- component info ------------------------------------------------------ */

static const struct genom_service_info genom_service_info[] = {
  {
    .name = "abort_activity",
    .input = "{ \"activity\":{ \"kind\":\"unsigned long\" } }",
    .output = "{ }",
    .meta = "{ \"activity\":{ \"doc\":\"Activity id\" } }",
    .init_input =
    (genom_initfn)genom_loco_client_abort_activity_init_input,
    .init_output =
    (genom_initfn)genom_loco_client_abort_activity_init_output,
    .fini_input =
    (genom_finifn)genom_loco_client_abort_activity_fini_input,
    .fini_output =
    (genom_finifn)genom_loco_client_abort_activity_fini_output,
    .json_scan =
    (genom_json_scanfn)genom_loco_client_abort_activity_json_scan,
    .json_print =
    (genom_json_printfn)genom_loco_client_abort_activity_json_print,
    .send =
    (genom_request_sendfn)genom_loco_client_abort_activity_rqst,
    .input_size = sizeof(struct genom_loco_abort_activity_input),
    .output_size = sizeof(struct genom_loco_abort_activity_output)
  },
  {
    .name = "connect_port",
    .input = "{ \"local\":{ \"kind\":\"string\",\"length\":128 },\"remote\":{ \"kind\":\"string\",\"length\":128 } }",
    .output = "{ }",
    .meta = "{ \"local\":{ \"doc\":\"Local input port\" },\"remote\":{ \"doc\":\"Output port to connect to\" } }",
    .init_input =
    (genom_initfn)genom_loco_client_connect_port_init_input,
    .init_output =
    (genom_initfn)genom_loco_client_connect_port_init_output,
    .fini_input =
    (genom_finifn)genom_loco_client_connect_port_fini_input,
    .fini_output =
    (genom_finifn)genom_loco_client_connect_port_fini_output,
    .json_scan =
    (genom_json_scanfn)genom_loco_client_connect_port_json_scan,
    .json_print =
    (genom_json_printfn)genom_loco_client_connect_port_json_print,
    .send =
    (genom_request_sendfn)genom_loco_client_connect_port_rqst,
    .input_size = sizeof(struct genom_loco_connect_port_input),
    .output_size = sizeof(struct genom_loco_connect_port_output)
  },
  {
    .name = "connect_service",
    .input = "{ \"local\":{ \"kind\":\"string\",\"length\":128 },\"remote\":{ \"kind\":\"string\",\"length\":128 } }",
    .output = "{ }",
    .meta = "{ \"local\":{ \"doc\":\"Local service name\" },\"remote\":{ \"doc\":\"Remote service name\" } }",
    .init_input =
    (genom_initfn)genom_loco_client_connect_service_init_input,
    .init_output =
    (genom_initfn)genom_loco_client_connect_service_init_output,
    .fini_input =
    (genom_finifn)genom_loco_client_connect_service_fini_input,
    .fini_output =
    (genom_finifn)genom_loco_client_connect_service_fini_output,
    .json_scan =
    (genom_json_scanfn)genom_loco_client_connect_service_json_scan,
    .json_print =
    (genom_json_printfn)genom_loco_client_connect_service_json_print,
    .send =
    (genom_request_sendfn)genom_loco_client_connect_service_rqst,
    .input_size = sizeof(struct genom_loco_connect_service_input),
    .output_size = sizeof(struct genom_loco_connect_service_output)
  },
  {
    .name = "kill",
    .input = "{ }",
    .output = "{ }",
    .meta = "{ }",
    .init_input =
    (genom_initfn)genom_loco_client_kill_init_input,
    .init_output =
    (genom_initfn)genom_loco_client_kill_init_output,
    .fini_input =
    (genom_finifn)genom_loco_client_kill_fini_input,
    .fini_output =
    (genom_finifn)genom_loco_client_kill_fini_output,
    .json_scan =
    (genom_json_scanfn)genom_loco_client_kill_json_scan,
    .json_print =
    (genom_json_printfn)genom_loco_client_kill_json_print,
    .send =
    (genom_request_sendfn)genom_loco_client_kill_rqst,
    .input_size = sizeof(struct genom_loco_kill_input),
    .output_size = sizeof(struct genom_loco_kill_output)
  },
  {
    .name = "GetCurrentPosition",
    .input = "{ }",
    .output = "{ \"position\":{ \"kind\":\"struct\",\"type\":{ \"position_avant\":{ \"kind\":\"struct\",\"type\":{ \"x\":{ \"kind\":\"float\" },\"y\":{ \"kind\":\"float\" } } },\"position_arriere_gauche\":{ \"kind\":\"struct\",\"type\":{ \"x\":{ \"kind\":\"float\" },\"y\":{ \"kind\":\"float\" } } },\"position_arriere_droit\":{ \"kind\":\"struct\",\"type\":{ \"x\":{ \"kind\":\"float\" },\"y\":{ \"kind\":\"float\" } } } } } }",
    .meta = "{ }",
    .init_input =
    (genom_initfn)genom_loco_client_GetCurrentPosition_init_input,
    .init_output =
    (genom_initfn)genom_loco_client_GetCurrentPosition_init_output,
    .fini_input =
    (genom_finifn)genom_loco_client_GetCurrentPosition_fini_input,
    .fini_output =
    (genom_finifn)genom_loco_client_GetCurrentPosition_fini_output,
    .json_scan =
    (genom_json_scanfn)genom_loco_client_GetCurrentPosition_json_scan,
    .json_print =
    (genom_json_printfn)genom_loco_client_GetCurrentPosition_json_print,
    .send =
    (genom_request_sendfn)genom_loco_client_GetCurrentPosition_rqst,
    .input_size = sizeof(struct genom_loco_GetCurrentPosition_input),
    .output_size = sizeof(struct genom_loco_GetCurrentPosition_output)
  },
  {
    .name = "GetCurrentBattery",
    .input = "{ }",
    .output = "{ \"batterie\":{ \"kind\":\"struct\",\"type\":{ \"nombre\":{ \"kind\":\"float\" } } } }",
    .meta = "{ }",
    .init_input =
    (genom_initfn)genom_loco_client_GetCurrentBattery_init_input,
    .init_output =
    (genom_initfn)genom_loco_client_GetCurrentBattery_init_output,
    .fini_input =
    (genom_finifn)genom_loco_client_GetCurrentBattery_fini_input,
    .fini_output =
    (genom_finifn)genom_loco_client_GetCurrentBattery_fini_output,
    .json_scan =
    (genom_json_scanfn)genom_loco_client_GetCurrentBattery_json_scan,
    .json_print =
    (genom_json_printfn)genom_loco_client_GetCurrentBattery_json_print,
    .send =
    (genom_request_sendfn)genom_loco_client_GetCurrentBattery_rqst,
    .input_size = sizeof(struct genom_loco_GetCurrentBattery_input),
    .output_size = sizeof(struct genom_loco_GetCurrentBattery_output)
  },
  {
    .name = "GetCurrentMap",
    .input = "{ }",
    .output = "{ \"image\":{ \"kind\":\"struct\",\"type\":{ \"R\":{ \"kind\":\"float\" },\"G\":{ \"kind\":\"float\" },\"B\":{ \"kind\":\"float\" } } } }",
    .meta = "{ }",
    .init_input =
    (genom_initfn)genom_loco_client_GetCurrentMap_init_input,
    .init_output =
    (genom_initfn)genom_loco_client_GetCurrentMap_init_output,
    .fini_input =
    (genom_finifn)genom_loco_client_GetCurrentMap_fini_input,
    .fini_output =
    (genom_finifn)genom_loco_client_GetCurrentMap_fini_output,
    .json_scan =
    (genom_json_scanfn)genom_loco_client_GetCurrentMap_json_scan,
    .json_print =
    (genom_json_printfn)genom_loco_client_GetCurrentMap_json_print,
    .send =
    (genom_request_sendfn)genom_loco_client_GetCurrentMap_rqst,
    .input_size = sizeof(struct genom_loco_GetCurrentMap_input),
    .output_size = sizeof(struct genom_loco_GetCurrentMap_output)
  },
  {
    .name = "GetCurrentArena",
    .input = "{ }",
    .output = "{ \"arene\":{ \"kind\":\"struct\",\"type\":{ \"haut_gauche\":{ \"kind\":\"struct\",\"type\":{ \"x\":{ \"kind\":\"float\" },\"y\":{ \"kind\":\"float\" } } },\"haut_droit\":{ \"kind\":\"struct\",\"type\":{ \"x\":{ \"kind\":\"float\" },\"y\":{ \"kind\":\"float\" } } },\"bas_gauche\":{ \"kind\":\"struct\",\"type\":{ \"x\":{ \"kind\":\"float\" },\"y\":{ \"kind\":\"float\" } } },\"bas_droit\":{ \"kind\":\"struct\",\"type\":{ \"x\":{ \"kind\":\"float\" },\"y\":{ \"kind\":\"float\" } } } } } }",
    .meta = "{ }",
    .init_input =
    (genom_initfn)genom_loco_client_GetCurrentArena_init_input,
    .init_output =
    (genom_initfn)genom_loco_client_GetCurrentArena_init_output,
    .fini_input =
    (genom_finifn)genom_loco_client_GetCurrentArena_fini_input,
    .fini_output =
    (genom_finifn)genom_loco_client_GetCurrentArena_fini_output,
    .json_scan =
    (genom_json_scanfn)genom_loco_client_GetCurrentArena_json_scan,
    .json_print =
    (genom_json_printfn)genom_loco_client_GetCurrentArena_json_print,
    .send =
    (genom_request_sendfn)genom_loco_client_GetCurrentArena_rqst,
    .input_size = sizeof(struct genom_loco_GetCurrentArena_input),
    .output_size = sizeof(struct genom_loco_GetCurrentArena_output)
  },
  {
    .name = "MoveStop",
    .input = "{ }",
    .output = "{ }",
    .meta = "{ }",
    .init_input =
    (genom_initfn)genom_loco_client_MoveStop_init_input,
    .init_output =
    (genom_initfn)genom_loco_client_MoveStop_init_output,
    .fini_input =
    (genom_finifn)genom_loco_client_MoveStop_fini_input,
    .fini_output =
    (genom_finifn)genom_loco_client_MoveStop_fini_output,
    .json_scan =
    (genom_json_scanfn)genom_loco_client_MoveStop_json_scan,
    .json_print =
    (genom_json_printfn)genom_loco_client_MoveStop_json_print,
    .send =
    (genom_request_sendfn)genom_loco_client_MoveStop_rqst,
    .input_size = sizeof(struct genom_loco_MoveStop_input),
    .output_size = sizeof(struct genom_loco_MoveStop_output)
  },
  {
    .name = "BattStop",
    .input = "{ }",
    .output = "{ }",
    .meta = "{ }",
    .init_input =
    (genom_initfn)genom_loco_client_BattStop_init_input,
    .init_output =
    (genom_initfn)genom_loco_client_BattStop_init_output,
    .fini_input =
    (genom_finifn)genom_loco_client_BattStop_fini_input,
    .fini_output =
    (genom_finifn)genom_loco_client_BattStop_fini_output,
    .json_scan =
    (genom_json_scanfn)genom_loco_client_BattStop_json_scan,
    .json_print =
    (genom_json_printfn)genom_loco_client_BattStop_json_print,
    .send =
    (genom_request_sendfn)genom_loco_client_BattStop_rqst,
    .input_size = sizeof(struct genom_loco_BattStop_input),
    .output_size = sizeof(struct genom_loco_BattStop_output)
  },
  {
    .name = "StartMove",
    .input = "{ }",
    .output = "{ }",
    .meta = "{ }",
    .init_input =
    (genom_initfn)genom_loco_client_StartMove_init_input,
    .init_output =
    (genom_initfn)genom_loco_client_StartMove_init_output,
    .fini_input =
    (genom_finifn)genom_loco_client_StartMove_fini_input,
    .fini_output =
    (genom_finifn)genom_loco_client_StartMove_fini_output,
    .json_scan =
    (genom_json_scanfn)genom_loco_client_StartMove_json_scan,
    .json_print =
    (genom_json_printfn)genom_loco_client_StartMove_json_print,
    .send =
    (genom_request_sendfn)genom_loco_client_StartMove_rqst,
    .input_size = sizeof(struct genom_loco_StartMove_input),
    .output_size = sizeof(struct genom_loco_StartMove_output)
  },
  {
    .name = "StartBatt",
    .input = "{ }",
    .output = "{ }",
    .meta = "{ }",
    .init_input =
    (genom_initfn)genom_loco_client_StartBatt_init_input,
    .init_output =
    (genom_initfn)genom_loco_client_StartBatt_init_output,
    .fini_input =
    (genom_finifn)genom_loco_client_StartBatt_fini_input,
    .fini_output =
    (genom_finifn)genom_loco_client_StartBatt_fini_output,
    .json_scan =
    (genom_json_scanfn)genom_loco_client_StartBatt_json_scan,
    .json_print =
    (genom_json_printfn)genom_loco_client_StartBatt_json_print,
    .send =
    (genom_request_sendfn)genom_loco_client_StartBatt_rqst,
    .input_size = sizeof(struct genom_loco_StartBatt_input),
    .output_size = sizeof(struct genom_loco_StartBatt_output)
  },
  { .name = NULL, .input = NULL, .output = NULL, .meta = NULL, .send = NULL }
};

static const struct genom_port_info genom_port_info[] = {
  {
    .name = "genom_state",
    .data = "{ \"genom_state\":{ \"kind\":\"struct\",\"type\":{ \"task\":{ \"kind\":\"sequence\",\"type\":{ \"kind\":\"struct\",\"type\":{ \"name\":{ \"kind\":\"string\",\"length\":64 },\"rusage\":{ \"kind\":\"struct\",\"type\":{ \"cycles\":{ \"kind\":\"unsigned long\" },\"timings\":{ \"kind\":\"struct\",\"type\":{ \"last\":{ \"kind\":\"float\" },\"max\":{ \"kind\":\"float\" },\"avg\":{ \"kind\":\"float\" } } },\"load\":{ \"kind\":\"struct\",\"type\":{ \"last\":{ \"kind\":\"float\" },\"max\":{ \"kind\":\"float\" },\"avg\":{ \"kind\":\"float\" } } } } },\"activity\":{ \"kind\":\"sequence\",\"type\":{ \"kind\":\"struct\",\"type\":{ \"id\":{ \"kind\":\"unsigned long\" },\"name\":{ \"kind\":\"string\",\"length\":64 } } } } } } },\"digest\":{ \"kind\":\"string\",\"length\":33 },\"date\":{ \"kind\":\"string\",\"length\":31 },\"version\":{ \"kind\":\"string\",\"length\":32 } } } }",
    .meta = "{}",
    .init_data =
    (genom_initfn)genom_loco_client_genom_state_init_data,
    .fini_data =
    (genom_finifn)genom_loco_client_genom_state_fini_data,
    .json_print =
    (genom_json_printfn)genom_loco_client_genom_state_json_print,
    .simple = 1,
    .read.simple =
    (genom_port_readfn)genom_loco_client_genom_state_port,
    .data_size = sizeof(genom_state_component)
  },
  {
    .name = "BAT",
    .data = "{ \"BAT\":{ \"kind\":\"struct\",\"type\":{ \"nombre\":{ \"kind\":\"float\" } } } }",
    .meta = "{}",
    .init_data =
    (genom_initfn)genom_loco_client_BAT_init_data,
    .fini_data =
    (genom_finifn)genom_loco_client_BAT_fini_data,
    .json_print =
    (genom_json_printfn)genom_loco_client_BAT_json_print,
    .simple = 1,
    .read.simple =
    (genom_port_readfn)genom_loco_client_BAT_port,
    .data_size = sizeof(loco_data)
  },
  { .name = NULL, .data = NULL, .meta = NULL,
    .init_data = NULL, .fini_data = NULL, .json_print = NULL,
    .simple = 1, .read.simple = NULL, .data_size = 0
  }
};

const struct genom_client_info genom_loco_client_info = {
  .protocol = genom_client_protocol,
  .name = "loco",
  .options = genom_pocolibs_options,

  .init = genom_loco_client_init,
  .fini = genom_loco_client_fini,
  .context = genom_loco_client_context,
  .instance = genom_loco_client_instance,
  .eventfd = genom_loco_client_eventfd,
  .service_info = genom_loco_client_service_info,
  .done = genom_loco_client_done,
  .wait = genom_loco_client_wait,
  .result = pocolibs_result,
  .clean = genom_loco_client_clean,
  .abort = genom_loco_client_abort,
  .doevents = genom_loco_client_doevents,
  .json_error = genom_loco_client_json_error,

  .nservices = 12,
  .services = genom_service_info,

  .nports = 2,
  .ports = genom_port_info
};

const struct genom_service_info *genom_loco_client_abort_activity_info =
  &genom_service_info[0];
const struct genom_service_info *genom_loco_client_connect_port_info =
  &genom_service_info[1];
const struct genom_service_info *genom_loco_client_connect_service_info =
  &genom_service_info[2];
const struct genom_service_info *genom_loco_client_kill_info =
  &genom_service_info[3];
const struct genom_service_info *genom_loco_client_GetCurrentPosition_info =
  &genom_service_info[4];
const struct genom_service_info *genom_loco_client_GetCurrentBattery_info =
  &genom_service_info[5];
const struct genom_service_info *genom_loco_client_GetCurrentMap_info =
  &genom_service_info[6];
const struct genom_service_info *genom_loco_client_GetCurrentArena_info =
  &genom_service_info[7];
const struct genom_service_info *genom_loco_client_MoveStop_info =
  &genom_service_info[8];
const struct genom_service_info *genom_loco_client_BattStop_info =
  &genom_service_info[9];
const struct genom_service_info *genom_loco_client_StartMove_info =
  &genom_service_info[10];
const struct genom_service_info *genom_loco_client_StartBatt_info =
  &genom_service_info[11];

const struct genom_port_info *genom_loco_client_genom_state_info =
  &genom_port_info[0];
const struct genom_port_info *genom_loco_client_BAT_info =
  &genom_port_info[1];
